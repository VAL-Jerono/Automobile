<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Portal | Karbima Care Insurance Brokers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0d6efd;
            --primary-dark: #0a58ca;
            --secondary: #198754;
            --accent: #ffc107;
            --danger: #dc3545;
            --dark: #1a1a2e;
            --sidebar-width: 280px;
            --gradient: linear-gradient(135deg, #0d6efd 0%, #198754 100%);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f4f6f9;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: var(--dark);
            color: #fff;
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-header i {
            font-size: 1.8rem;
            color: var(--accent);
        }

        .sidebar-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .sidebar-header span {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .agent-profile {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }

        .agent-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            border: 3px solid var(--accent);
        }

        .agent-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .agent-id {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .agent-tier {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--accent);
            color: var(--dark);
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-section {
            padding: 0.5rem 1.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.5;
            margin-top: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border-left-color: var(--accent);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        .topbar {
            background: #fff;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .topbar h4 {
            font-weight: 600;
            color: var(--dark);
            margin: 0;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
        }

        .notification-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: #fff;
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
        }

        .content-area {
            padding: 2rem;
        }

        /* Dashboard Cards */
        .stat-card {
            background: #fff;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .stat-card.primary { border-left: 4px solid var(--primary); }
        .stat-card.success { border-left: 4px solid var(--secondary); }
        .stat-card.warning { border-left: 4px solid var(--accent); }
        .stat-card.danger { border-left: 4px solid var(--danger); }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: #fff;
        }

        .stat-icon.primary { background: var(--primary); }
        .stat-icon.success { background: var(--secondary); }
        .stat-icon.warning { background: var(--accent); color: var(--dark); }
        .stat-icon.danger { background: var(--danger); }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--dark);
            margin: 0;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin: 0;
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .stat-change.up { color: var(--secondary); }
        .stat-change.down { color: var(--danger); }

        /* Tables */
        .card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            border: none;
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: none;
            border-bottom: 1px solid #eee;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .table {
            margin: 0;
        }

        .table th {
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            border-top: none;
        }

        .table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.pending { background: #fff3cd; color: #856404; }
        .status-badge.active { background: #d4edda; color: #155724; }
        .status-badge.expired { background: #f8d7da; color: #721c24; }
        .status-badge.renewal { background: #cce5ff; color: #004085; }

        /* Quick Actions */
        .quick-action-card {
            background: #fff;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .quick-action-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
        }

        .quick-action-card i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
        }

        .quick-action-card h6 {
            margin: 0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Renewal Alerts */
        .alert-card {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: none;
            border-radius: 15px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .alert-card i {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .alert-card .info {
            flex: 1;
        }

        .alert-card .info h6 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #856404;
        }

        .alert-card .info p {
            margin: 0;
            font-size: 0.8rem;
            color: #856404;
            opacity: 0.8;
        }

        .alert-card .days {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--danger);
        }

        /* Shareable Bot Link */
        .share-bot-section {
            background: var(--gradient);
            border-radius: 15px;
            padding: 1.5rem;
            color: #fff;
            margin-bottom: 1.5rem;
        }

        .share-bot-section h5 {
            margin-bottom: 1rem;
        }

        .share-link-box {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .share-link-box input {
            flex: 1;
            background: none;
            border: none;
            color: #fff;
            font-size: 0.85rem;
        }

        .share-link-box button {
            background: #fff;
            color: var(--primary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .share-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .share-buttons a {
            flex: 1;
            padding: 0.75rem;
            background: rgba(255,255,255,0.2);
            color: #fff;
            text-decoration: none;
            text-align: center;
            border-radius: 10px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .share-buttons a:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Commission Tracker */
        .commission-card {
            background: linear-gradient(135deg, var(--secondary) 0%, #20c997 100%);
            border-radius: 15px;
            padding: 1.5rem;
            color: #fff;
        }

        .commission-card h5 {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .commission-card .amount {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .commission-card .period {
            opacity: 0.8;
            font-size: 0.8rem;
        }

        /* Chat Section */
        .chat-section {
            display: none;
        }

        .chat-section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt"></i>
            <div>
                <h3>Karbima Care</h3>
                <span>Agent Portal</span>
            </div>
        </div>

        <div class="agent-profile">
            <img src="https://ui-avatars.com/api/?name=John+Mwangi&background=667eea&color=fff&size=80" 
                 alt="Agent" class="agent-avatar">
            <div class="agent-name">John Mwangi</div>
            <div class="agent-id">Agent ID: KBC-2024-0847</div>
            <span class="agent-tier">⭐ Gold Agent</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">Main Menu</div>
            <a href="#dashboard" class="nav-item active" data-section="dashboard">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="#new-business" class="nav-item" data-section="new-business">
                <i class="fas fa-plus-circle"></i> New Business
                <span class="badge">3</span>
            </a>
            <a href="#pending" class="nav-item" data-section="pending">
                <i class="fas fa-clock"></i> Pending Business
                <span class="badge">12</span>
            </a>
            <a href="#active" class="nav-item" data-section="active">
                <i class="fas fa-check-circle"></i> Active Covers
            </a>
            <a href="#completed" class="nav-item" data-section="completed">
                <i class="fas fa-archive"></i> Completed Cases
            </a>

            <div class="nav-section">Alerts</div>
            <a href="#renewals" class="nav-item" data-section="renewals">
                <i class="fas fa-bell"></i> Renewals Due
                <span class="badge">8</span>
            </a>
            <a href="#claims" class="nav-item" data-section="claims">
                <i class="fas fa-file-alt"></i> Claims
            </a>

            <div class="nav-section">Tools</div>
            <a href="#customer-bot" class="nav-item" data-section="customer-bot">
                <i class="fas fa-robot"></i> Customer Bot
            </a>
            <a href="#calculator" class="nav-item" data-section="calculator">
                <i class="fas fa-calculator"></i> Premium Calculator
            </a>
            <a href="#documents" class="nav-item" data-section="documents">
                <i class="fas fa-folder"></i> Documents
                <span class="badge" style="background: #17a2b8;">3</span>
            </a>

            <div class="nav-section">Account</div>
            <a href="#commissions" class="nav-item" data-section="commissions">
                <i class="fas fa-money-bill-wave"></i> Commissions
            </a>
            <a href="#settings" class="nav-item" data-section="settings">
                <i class="fas fa-cog"></i> Settings
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Topbar -->
        <header class="topbar">
            <h4>Agent Dashboard</h4>
            <div class="topbar-right">
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="badge">8</span>
                </button>
                <a href="index.html" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-home"></i> Main Site
                </a>
                <a href="admin-portal.html" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-user-shield"></i> Admin
                </a>
            </div>
        </header>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Dashboard Section -->
            <section id="section-dashboard" class="content-section active">
                <!-- Stats Row -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card primary">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="stat-label">Active Policies</p>
                                    <h3 class="stat-value">156</h3>
                                    <p class="stat-change up"><i class="fas fa-arrow-up"></i> +12% this month</p>
                                </div>
                                <div class="stat-icon primary">
                                    <i class="fas fa-file-contract"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card success">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="stat-label">Total Customers</p>
                                    <h3 class="stat-value">89</h3>
                                    <p class="stat-change up"><i class="fas fa-arrow-up"></i> +5 new</p>
                                </div>
                                <div class="stat-icon success">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card warning">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="stat-label">Pending Approvals</p>
                                    <h3 class="stat-value">12</h3>
                                    <p class="stat-change">Awaiting underwriting</p>
                                </div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card danger">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="stat-label">Renewals Due</p>
                                    <h3 class="stat-value">8</h3>
                                    <p class="stat-change">Next 30 days</p>
                                </div>
                                <div class="stat-icon danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Left Column -->
                    <div class="col-lg-8">
                        <!-- Quick Actions -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <div class="quick-action-card" onclick="showSection('new-business')">
                                            <i class="fas fa-plus-circle"></i>
                                            <h6>New Policy</h6>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="quick-action-card" onclick="showSection('calculator')">
                                            <i class="fas fa-calculator"></i>
                                            <h6>Get Quote</h6>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="quick-action-card" onclick="showSection('claims')">
                                            <i class="fas fa-file-alt"></i>
                                            <h6>File Claim</h6>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="quick-action-card" onclick="showSection('customer-bot')">
                                            <i class="fas fa-share-alt"></i>
                                            <h6>Share Bot</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Business Table -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-clock me-2"></i>Pending Business</h5>
                                <a href="#" class="btn btn-sm btn-outline-primary">View All</a>
                            </div>
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Customer</th>
                                            <th>Vehicle</th>
                                            <th>Cover</th>
                                            <th>Premium</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <strong>Mary Wanjiku</strong><br>
                                                <small class="text-muted">KDA 123A</small>
                                            </td>
                                            <td>Toyota Vitz 2018</td>
                                            <td>Comprehensive</td>
                                            <td>KES 45,000</td>
                                            <td><span class="status-badge pending">Awaiting Docs</span></td>
                                            <td><button class="btn btn-sm btn-primary">Follow Up</button></td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <strong>Peter Kamau</strong><br>
                                                <small class="text-muted">KBZ 456B</small>
                                            </td>
                                            <td>Honda Fit 2016</td>
                                            <td>TPFT</td>
                                            <td>KES 18,500</td>
                                            <td><span class="status-badge pending">Under Review</span></td>
                                            <td><button class="btn btn-sm btn-outline-primary">View</button></td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <strong>Safari Tours Ltd</strong><br>
                                                <small class="text-muted">KCB 789C</small>
                                            </td>
                                            <td>Toyota Hiace (PSV)</td>
                                            <td>Comprehensive</td>
                                            <td>KES 125,000</td>
                                            <td><span class="status-badge pending">Pricing</span></td>
                                            <td><button class="btn btn-sm btn-outline-primary">View</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-lg-4">
                        <!-- Commission Card -->
                        <div class="commission-card mb-4">
                            <h5>This Month's Commission</h5>
                            <div class="amount">KES 47,850</div>
                            <p class="period">December 2025</p>
                            <hr style="opacity:0.3">
                            <div class="d-flex justify-content-between" style="font-size:0.85rem">
                                <span>Pending Payout:</span>
                                <strong>KES 23,400</strong>
                            </div>
                        </div>

                        <!-- Renewal Alerts -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-bell me-2 text-warning"></i>Renewal Alerts</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert-card">
                                    <i class="fas fa-car"></i>
                                    <div class="info">
                                        <h6>James Otieno - KAA 111Z</h6>
                                        <p>Comprehensive - Jubilee</p>
                                    </div>
                                    <div class="days">3d</div>
                                </div>
                                <div class="alert-card">
                                    <i class="fas fa-car"></i>
                                    <div class="info">
                                        <h6>Grace Muthoni - KBB 222Y</h6>
                                        <p>TPO - Britam</p>
                                    </div>
                                    <div class="days">7d</div>
                                </div>
                                <div class="alert-card">
                                    <i class="fas fa-truck"></i>
                                    <div class="info">
                                        <h6>Cargo Express - KCC 333X</h6>
                                        <p>Commercial - CIC</p>
                                    </div>
                                    <div class="days">12d</div>
                                </div>
                                <a href="#renewals" class="btn btn-outline-warning btn-sm w-100 mt-2">
                                    View All Renewals (8)
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Customer Bot Section -->
            <section id="section-customer-bot" class="content-section" style="display:none">
                <h4 class="mb-4"><i class="fas fa-robot me-2"></i>Your Customer Communication Bot</h4>
                
                <div class="share-bot-section">
                    <h5><i class="fas fa-share-alt me-2"></i>Share Your Personal Bot Link</h5>
                    <p style="opacity:0.9; font-size:0.9rem; margin-bottom:1rem;">
                        Customers can use this link to request quotes, submit documents, or ask insurance questions. 
                        All inquiries come directly to you!
                    </p>
                    <div class="share-link-box">
                        <i class="fas fa-link"></i>
                        <input type="text" id="botLink" value="https://karbimacare.co.ke/bot/agent/KBC-2024-0847" readonly>
                        <button onclick="copyBotLink()">Copy</button>
                    </div>
                    <div class="share-buttons">
                        <a href="https://wa.me/?text=Get%20your%20motor%20insurance%20rate%20comparison%20instantly!%20https://karbimacare.co.ke/bot/agent/KBC-2024-0847" target="_blank">
                            <i class="fab fa-whatsapp me-2"></i>WhatsApp
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://karbimacare.co.ke/bot/agent/KBC-2024-0847" target="_blank">
                            <i class="fab fa-facebook me-2"></i>Facebook
                        </a>
                        <a href="sms:?body=Get%20your%20motor%20insurance%20rate%20comparison%20instantly!%20https://karbimacare.co.ke/bot/agent/KBC-2024-0847">
                            <i class="fas fa-sms me-2"></i>SMS
                        </a>
                        <a href="mailto:?subject=Get%20Motor%20Insurance%20Rates&body=Get%20your%20motor%20insurance%20rate%20comparison%20instantly!%20https://karbimacare.co.ke/bot/agent/KBC-2024-0847">
                            <i class="fas fa-envelope me-2"></i>Email
                        </a>
                    </div>
                </div>

                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-inbox me-2"></i>Customer Inquiries via Bot</h5>
                            </div>
                            <div class="card-body">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Customer</th>
                                            <th>Request Type</th>
                                            <th>Vehicle</th>
                                            <th>Time</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <strong>Ann Njeri</strong><br>
                                                <small>+254 712 345 678</small>
                                            </td>
                                            <td><span class="badge bg-primary">Quote Request</span></td>
                                            <td>Toyota Corolla 2020</td>
                                            <td>10 mins ago</td>
                                            <td>
                                                <button class="btn btn-sm btn-success">Respond</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <strong>David Ochieng</strong><br>
                                                <small>+254 723 456 789</small>
                                            </td>
                                            <td><span class="badge bg-info">Document Upload</span></td>
                                            <td>Nissan X-Trail 2019</td>
                                            <td>1 hour ago</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">View Docs</button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <strong>Lucy Wambui</strong><br>
                                                <small>+254 734 567 890</small>
                                            </td>
                                            <td><span class="badge bg-warning text-dark">Claim Query</span></td>
                                            <td>Mazda Demio 2017</td>
                                            <td>3 hours ago</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary">Reply</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar me-2"></i>Bot Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Total Conversations</span>
                                    <strong>234</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Quote Requests</span>
                                    <strong>89</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Converted to Policies</span>
                                    <strong class="text-success">23</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Conversion Rate</span>
                                    <strong class="text-primary">25.8%</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <span>Revenue from Bot</span>
                                    <strong class="text-success">KES 1.2M</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Rate Calculator Section -->
            <section id="section-calculator" class="content-section" style="display:none">
                <h4 class="mb-4"><i class="fas fa-calculator me-2"></i>Insurance Rate Calculator</h4>
                
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Vehicle & Customer Details</h5>
                            </div>
                            <div class="card-body">
                                <form id="quoteForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Cover Type</label>
                                            <select class="form-select" id="coverType">
                                                <option value="comprehensive">Comprehensive</option>
                                                <option value="tpft">Third Party Fire & Theft</option>
                                                <option value="tpo">Third Party Only</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Vehicle Use</label>
                                            <select class="form-select" id="vehicleUse">
                                                <option value="private">Private</option>
                                                <option value="commercial">Commercial</option>
                                                <option value="psv">PSV (Matatu)</option>
                                                <option value="tour">Tour Van</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Vehicle Value (KES)</label>
                                            <input type="number" class="form-control" id="vehicleValue" value="1500000">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Year of Manufacture</label>
                                            <input type="number" class="form-control" id="vehicleYear" value="2020">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Engine CC</label>
                                            <input type="number" class="form-control" id="engineCC" value="1500">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Driver Age</label>
                                            <input type="number" class="form-control" id="driverAge" value="35">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Driving Experience (Years)</label>
                                            <input type="number" class="form-control" id="experience" value="10">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Previous Claims</label>
                                            <select class="form-select" id="claims">
                                                <option value="0">None (81.4% of customers)</option>
                                                <option value="1">1 Claim</option>
                                                <option value="2">2+ Claims</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <button type="button" class="btn btn-primary w-100" onclick="calculateRates()">
                                                <i class="fas fa-calculator me-2"></i>Compare Rates
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Rate Comparison (% of Vehicle Value)</h5>
                            </div>
                            <div class="card-body" id="premiumResults">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-calculator fa-3x mb-3"></i>
                                    <p>Enter vehicle details and click Compare Rates to see rate options from all insurers</p>
                                    <p class="small"><em>Client calculates: Rate × Vehicle Value = Premium</em></p>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-4">
                            <div class="card-header">
                                <h5><i class="fas fa-brain me-2"></i>AI Risk Assessment (Based on 105,555 policies)</h5>
                            </div>
                            <div class="card-body" id="riskResults">
                                <div class="text-center text-muted py-3">
                                    <p class="small">Risk assessment will appear after calculation</p>
                                    <p class="small text-primary">Churn Model: 83% accuracy | Claims Model: 88% accuracy</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Documents Section - OCR Processed Customer Documents -->
            <section id="section-documents" class="content-section" style="display:none">
                <h4 class="mb-4"><i class="fas fa-folder-open me-2"></i>Customer Documents (OCR Processed)</h4>
                
                <!-- Document Notifications Banner -->
                <div id="documentNotifications" class="mb-4">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <div class="spinner-border spinner-border-sm me-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Loading document notifications...</div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Left Column - Document Queue -->
                    <div class="col-lg-8">
                        <!-- New Document Uploads -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="fas fa-bell text-warning me-2"></i>New Document Uploads</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshDocuments()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body" id="newDocumentsQueue">
                                <!-- Document items will be loaded here -->
                                <div class="text-center py-4 text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p>No new documents to review</p>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Documents Table -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-history me-2"></i>Recently Processed Documents</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Document ID</th>
                                                <th>Customer</th>
                                                <th>Type</th>
                                                <th>Uploaded</th>
                                                <th>Confidence</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentDocumentsTable">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted py-4">
                                                    <i class="fas fa-file-alt fa-2x mb-2"></i><br>
                                                    No documents yet. Customer uploads will appear here.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Document Details & Stats -->
                    <div class="col-lg-4">
                        <!-- Document Stats Card -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-pie me-2"></i>Document Statistics</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Total Documents</span>
                                    <strong id="statTotalDocs">0</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Pending Review</span>
                                    <strong id="statPendingDocs" class="text-warning">0</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Processed Today</span>
                                    <strong id="statTodayDocs" class="text-success">0</strong>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-3">
                                    <span>Avg. OCR Confidence</span>
                                    <strong class="text-primary">92%</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Auto-Extract Success</span>
                                    <strong class="text-success">95%</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Document Type Breakdown -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5><i class="fas fa-file-alt me-2"></i>Document Types</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span><i class="fas fa-car text-primary me-2"></i>Logbooks</span>
                                    <span class="badge bg-primary" id="countLogbooks">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span><i class="fas fa-id-card text-info me-2"></i>National IDs</span>
                                    <span class="badge bg-info" id="countIds">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span><i class="fas fa-id-badge text-success me-2"></i>Driving Licenses</span>
                                    <span class="badge bg-success" id="countLicenses">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span><i class="fas fa-camera text-warning me-2"></i>Vehicle Photos</span>
                                    <span class="badge bg-warning" id="countPhotos">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-file-signature text-secondary me-2"></i>Proposals</span>
                                    <span class="badge bg-secondary" id="countProposals">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Selected Document Preview -->
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-eye me-2"></i>Extracted Data Preview</h5>
                            </div>
                            <div class="card-body" id="documentPreview">
                                <div class="text-center text-muted py-3">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <p class="small">Select a document to view extracted data</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Excel CRM Export -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1"><i class="fas fa-file-excel text-success me-2"></i>Excel CRM Auto-Sync</h6>
                                    <p class="text-muted mb-0 small">All documents are automatically synced to your Excel CRM file</p>
                                </div>
                                <div>
                                    <button class="btn btn-success" onclick="downloadCRM()">
                                        <i class="fas fa-download me-2"></i>Download CRM
                                    </button>
                                    <button class="btn btn-outline-secondary ms-2" onclick="viewCRMStatus()">
                                        <i class="fas fa-info-circle me-2"></i>Sync Status
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                showSection(section);
            });
        });

        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            // Show selected section
            const section = document.getElementById('section-' + sectionName);
            if (section) section.style.display = 'block';
            // Update nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`.nav-item[data-section="${sectionName}"]`)?.classList.add('active');
        }

        // Copy bot link
        function copyBotLink() {
            const input = document.getElementById('botLink');
            input.select();
            document.execCommand('copy');
            alert('Bot link copied to clipboard!');
        }

        // Calculate Rates using actual data statistics
        async function calculateRates() {
            const coverType = document.getElementById('coverType').value;
            const vehicleUse = document.getElementById('vehicleUse').value;
            const vehicleValue = parseFloat(document.getElementById('vehicleValue').value);
            const vehicleYear = parseInt(document.getElementById('vehicleYear').value);
            const engineCC = parseInt(document.getElementById('engineCC').value);
            const driverAge = parseInt(document.getElementById('driverAge').value);
            const experience = parseInt(document.getElementById('experience').value);
            const claims = parseInt(document.getElementById('claims').value);

            const vehicleAge = 2025 - vehicleYear;
            
            // Base rates by cover type (% of vehicle value)
            const baseRates = {
                comprehensive: { min: 5.0, max: 7.5 },
                tpft: { min: 4.0, max: 5.0 },
                tpo: { min: 3.0, max: 4.0 }
            };

            // Risk category from actual data: Low (8%), Medium (13%), High (79%), Very High (1%)
            let riskCategory = 'Medium';
            let riskMultiplier = 1.0;
            
            // Determine risk based on actual factors
            if (vehicleAge > 15 || driverAge < 25 || claims > 1) {
                riskCategory = 'High';
                riskMultiplier = 1.15;
            } else if (vehicleAge > 10 || experience < 3 || claims > 0) {
                riskCategory = 'Medium';
                riskMultiplier = 1.0;
            } else if (vehicleAge <= 5 && experience >= 5 && claims === 0) {
                riskCategory = 'Low';
                riskMultiplier = 0.9;
            }
            
            if (vehicleUse === 'psv') riskMultiplier += 0.3;
            if (vehicleUse === 'commercial') riskMultiplier += 0.15;

            // Generate rate comparisons from different insurers
            const insurers = [
                { name: 'Jubilee', logo: '🏆', rateOffset: 0.0 },
                { name: 'Britam', logo: '🔵', rateOffset: -0.2 },
                { name: 'APA', logo: '🟢', rateOffset: 0.1 },
                { name: 'CIC', logo: '🟡', rateOffset: -0.1 },
                { name: 'UAP', logo: '🔴', rateOffset: 0.2 },
                { name: 'Madison', logo: '🟣', rateOffset: -0.15 },
            ];

            const base = baseRates[coverType];
            
            let resultsHTML = `
                <div class="alert alert-info mb-3">
                    <strong>Rate Formula:</strong> Rate % × Vehicle Value = Annual Premium<br>
                    <small>Example: 5.5% × KES ${vehicleValue.toLocaleString()} = KES ${Math.round(vehicleValue * 0.055).toLocaleString()}</small>
                </div>
                <div class="row g-3">
            `;
            
            insurers.forEach(insurer => {
                const minRate = Math.max(base.min, (base.min + insurer.rateOffset) * riskMultiplier);
                const maxRate = Math.min(base.max + 1, (base.max + insurer.rateOffset) * riskMultiplier);
                resultsHTML += `
                    <div class="col-12">
                        <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                            <div>
                                <span style="font-size:1.5rem">${insurer.logo}</span>
                                <strong class="ms-2">${insurer.name}</strong>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-primary" style="font-size:1.2rem">${minRate.toFixed(1)}% - ${maxRate.toFixed(1)}%</div>
                                <small class="text-muted">of vehicle value</small>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="selectRate('${insurer.name}', ${minRate}, ${maxRate})">Select</button>
                        </div>
                    </div>
                `;
            });
            resultsHTML += '</div>';

            document.getElementById('premiumResults').innerHTML = resultsHTML;

            // Risk assessment based on actual model data
            // From analysis: Low 8%, Medium 13%, High 79%, Very High 1%
            let riskScore = 50;
            if (riskCategory === 'Low') riskScore = 25;
            else if (riskCategory === 'Medium') riskScore = 45;
            else if (riskCategory === 'High') riskScore = 70;
            
            // Churn probability (from model: 19.2% base churn rate)
            let churnProb = 19.2;
            if (claims > 0) churnProb += 10;
            if (experience < 3) churnProb += 5;
            
            // Claims probability (from model: 18.6% base claims rate)
            let claimsProb = 18.6;
            if (vehicleAge > 10) claimsProb += 8;
            if (driverAge < 25) claimsProb += 12;

            let riskColor = 'success';
            if (riskScore > 50) riskColor = 'warning';
            if (riskScore > 70) riskColor = 'danger';

            document.getElementById('riskResults').innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="h4 text-${riskColor} mb-0">${riskCategory}</div>
                            <small class="text-muted">Risk Category</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="h4 text-warning mb-0">${churnProb.toFixed(1)}%</div>
                            <small class="text-muted">Churn Risk</small>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="border rounded p-2">
                            <div class="h4 text-info mb-0">${claimsProb.toFixed(1)}%</div>
                            <small class="text-muted">Claims Prob</small>
                        </div>
                    </div>
                </div>
                <hr>
                <p class="small text-muted mb-0 text-center">
                    Predictions based on ML models trained on 105,555 policies<br>
                    Churn AUC: 0.83 | Claims AUC: 0.88
                </p>
            `;
        }
        
        function selectRate(insurer, minRate, maxRate) {
            const vehicleValue = parseFloat(document.getElementById('vehicleValue').value);
            const avgRate = (minRate + maxRate) / 2;
            const estPremium = Math.round(vehicleValue * avgRate / 100);
            alert(`${insurer} Selected!\n\nRate Range: ${minRate.toFixed(1)}% - ${maxRate.toFixed(1)}%\nVehicle Value: KES ${vehicleValue.toLocaleString()}\nEstimated Premium: KES ${estPremium.toLocaleString()}\n\nProceed to create policy with this insurer.`);
        }

        // ============================================
        // DOCUMENT MANAGEMENT FUNCTIONS
        // ============================================
        
        const AGENT_CODE = 'KBC-2024-0847'; // Current agent's code
        const API_BASE = 'http://localhost:8001/api/v1';
        
        // Refresh documents and notifications
        async function refreshDocuments() {
            await loadDocumentNotifications();
            await loadRecentDocuments();
        }
        
        // Load document notifications for agent
        async function loadDocumentNotifications() {
            const container = document.getElementById('documentNotifications');
            
            try {
                const response = await fetch(`${API_BASE}/documents/notifications/${AGENT_CODE}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.total_notifications > 0) {
                        let html = `
                            <div class="alert alert-warning d-flex align-items-center" role="alert">
                                <i class="fas fa-bell fa-2x me-3"></i>
                                <div class="flex-grow-1">
                                    <strong>${data.total_notifications} New Document(s) Received!</strong>
                                    <p class="mb-0 small">Customers have uploaded documents for your review.</p>
                                </div>
                                <button class="btn btn-warning btn-sm" onclick="markNotificationsRead()">
                                    Mark All Read
                                </button>
                            </div>
                        `;
                        container.innerHTML = html;
                        
                        // Update new documents queue
                        updateNewDocumentsQueue(data.notifications);
                        
                        // Update notification badge in sidebar
                        updateNotificationBadge(data.total_notifications);
                    } else {
                        container.innerHTML = `
                            <div class="alert alert-success d-flex align-items-center" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                <div>All caught up! No new documents to review.</div>
                            </div>
                        `;
                    }
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                // Demo mode - show sample notifications
                container.innerHTML = `
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Demo Mode</strong> - Document API not connected. 
                            When customers upload documents on the portal, notifications will appear here.
                        </div>
                    </div>
                `;
                
                // Show sample data
                showSampleDocuments();
            }
        }
        
        // Update new documents queue
        function updateNewDocumentsQueue(notifications) {
            const container = document.getElementById('newDocumentsQueue');
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No new documents to review</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            notifications.forEach(notif => {
                const docIcon = getDocumentIcon(notif.document_type);
                html += `
                    <div class="d-flex align-items-start p-3 border rounded mb-2 bg-light">
                        <div class="me-3">
                            <i class="${docIcon.icon} fa-2x" style="color: ${docIcon.color}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <strong>${notif.customer_name}</strong>
                                <small class="text-muted">${formatTimeAgo(notif.timestamp)}</small>
                            </div>
                            <p class="mb-1 small">${notif.customer_email} | ${notif.customer_phone}</p>
                            <span class="badge bg-primary">${notif.document_type.replace('_', ' ').toUpperCase()}</span>
                            <span class="badge bg-success">${(notif.confidence * 100).toFixed(0)}% Confidence</span>
                        </div>
                        <div class="ms-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDocumentDetails('${notif.document_id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Show sample documents for demo
        function showSampleDocuments() {
            const sampleDocs = [
                {
                    document_id: 'DOC-20250101-DEMO001',
                    customer_name: 'Jane Wanjiku',
                    customer_email: 'jane.wanjiku@email.com',
                    customer_phone: '+254 722 111 222',
                    document_type: 'logbook',
                    timestamp: new Date(Date.now() - 30 * 60000).toISOString(),
                    confidence: 0.94,
                    extracted_data: {
                        registration_number: 'KDA 456B',
                        owner_name: 'Jane Wanjiku',
                        chassis_number: 'WVWZZZ3CZ1E123456',
                        make_model: 'Toyota Corolla',
                        year_of_manufacture: '2020'
                    }
                },
                {
                    document_id: 'DOC-20250101-DEMO002',
                    customer_name: 'Peter Kamau',
                    customer_email: 'peter.k@gmail.com',
                    customer_phone: '+254 733 222 333',
                    document_type: 'national_id',
                    timestamp: new Date(Date.now() - 2 * 60 * 60000).toISOString(),
                    confidence: 0.89,
                    extracted_data: {
                        id_number: '12345678',
                        full_name: 'Peter Njoroge Kamau',
                        date_of_birth: '1985-06-15'
                    }
                },
                {
                    document_id: 'DOC-20250101-DEMO003',
                    customer_name: 'Mary Akinyi',
                    customer_email: 'mary.akinyi@company.co.ke',
                    customer_phone: '+254 744 333 444',
                    document_type: 'driving_license',
                    timestamp: new Date(Date.now() - 5 * 60 * 60000).toISOString(),
                    confidence: 0.91,
                    extracted_data: {
                        license_number: 'DL-2024-123456',
                        holder_name: 'Mary Akinyi Oduya',
                        license_class: 'B, C',
                        expiry_date: '2027-03-15'
                    }
                }
            ];
            
            updateNewDocumentsQueue(sampleDocs);
            updateRecentDocumentsTable(sampleDocs);
            updateDocumentStats(sampleDocs);
        }
        
        // Update recent documents table
        function updateRecentDocumentsTable(docs) {
            const tbody = document.getElementById('recentDocumentsTable');
            
            if (!docs || docs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No documents yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            docs.forEach(doc => {
                const docIcon = getDocumentIcon(doc.document_type);
                const confidenceClass = doc.confidence >= 0.9 ? 'success' : doc.confidence >= 0.7 ? 'warning' : 'danger';
                
                html += `
                    <tr>
                        <td><code>${doc.document_id}</code></td>
                        <td>
                            <strong>${doc.customer_name}</strong><br>
                            <small class="text-muted">${doc.customer_email}</small>
                        </td>
                        <td>
                            <i class="${docIcon.icon}" style="color: ${docIcon.color}"></i>
                            ${doc.document_type.replace('_', ' ')}
                        </td>
                        <td>${formatTimeAgo(doc.timestamp)}</td>
                        <td>
                            <span class="badge bg-${confidenceClass}">
                                ${(doc.confidence * 100).toFixed(0)}%
                            </span>
                        </td>
                        <td><span class="status-badge active">Processed</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDocumentDetails('${doc.document_id}', ${JSON.stringify(doc.extracted_data).replace(/"/g, '&quot;')})">
                                <i class="fas fa-search"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Update document statistics
        function updateDocumentStats(docs) {
            document.getElementById('statTotalDocs').textContent = docs.length;
            document.getElementById('statPendingDocs').textContent = Math.floor(docs.length * 0.3);
            document.getElementById('statTodayDocs').textContent = Math.floor(docs.length * 0.7);
            
            // Count by type
            const typeCounts = {};
            docs.forEach(doc => {
                typeCounts[doc.document_type] = (typeCounts[doc.document_type] || 0) + 1;
            });
            
            document.getElementById('countLogbooks').textContent = typeCounts['logbook'] || 0;
            document.getElementById('countIds').textContent = typeCounts['national_id'] || 0;
            document.getElementById('countLicenses').textContent = typeCounts['driving_license'] || 0;
            document.getElementById('countPhotos').textContent = typeCounts['vehicle_photo'] || 0;
            document.getElementById('countProposals').textContent = typeCounts['insurance_proposal'] || 0;
        }
        
        // Get document icon
        function getDocumentIcon(docType) {
            const icons = {
                'logbook': { icon: 'fas fa-car', color: '#0d6efd' },
                'national_id': { icon: 'fas fa-id-card', color: '#17a2b8' },
                'driving_license': { icon: 'fas fa-id-badge', color: '#28a745' },
                'vehicle_photo': { icon: 'fas fa-camera', color: '#ffc107' },
                'insurance_proposal': { icon: 'fas fa-file-signature', color: '#6c757d' }
            };
            return icons[docType] || { icon: 'fas fa-file', color: '#6c757d' };
        }
        
        // Format time ago
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }
        
        // View document details
        function viewDocumentDetails(docId, extractedData) {
            const preview = document.getElementById('documentPreview');
            
            if (!extractedData) {
                preview.innerHTML = `
                    <div class="text-center py-3">
                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                        <p>Loading...</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="mb-3">
                    <small class="text-muted">Document ID:</small>
                    <div><code>${docId}</code></div>
                </div>
                <hr>
                <h6 class="mb-3"><i class="fas fa-database me-2"></i>Extracted Fields</h6>
            `;
            
            for (const [key, value] of Object.entries(extractedData)) {
                const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                        <small class="text-muted">${formattedKey}</small>
                        <strong>${value || 'N/A'}</strong>
                    </div>
                `;
            }
            
            html += `
                <hr>
                <button class="btn btn-sm btn-primary w-100 mb-2" onclick="approveDocument('${docId}')">
                    <i class="fas fa-check me-2"></i>Approve & Create Policy
                </button>
                <button class="btn btn-sm btn-outline-secondary w-100" onclick="editExtractedData('${docId}')">
                    <i class="fas fa-edit me-2"></i>Edit Extracted Data
                </button>
            `;
            
            preview.innerHTML = html;
        }
        
        // Update notification badge
        function updateNotificationBadge(count) {
            const badge = document.querySelector('.nav-item[data-section="documents"] .badge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
        }
        
        // Mark notifications as read
        async function markNotificationsRead() {
            try {
                await fetch(`${API_BASE}/documents/notifications/${AGENT_CODE}/clear`, { method: 'POST' });
            } catch (e) {}
            
            document.getElementById('documentNotifications').innerHTML = `
                <div class="alert alert-success d-flex align-items-center" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <div>All notifications marked as read.</div>
                </div>
            `;
            updateNotificationBadge(0);
        }
        
        // Download CRM Excel file
        function downloadCRM() {
            alert('Downloading CRM Excel file...\n\nFile: CRM_' + AGENT_CODE + '.xlsx\n\nThis contains all customer documents and extracted data.');
        }
        
        // View CRM sync status
        function viewCRMStatus() {
            alert('Excel CRM Sync Status:\n\n✓ Last Sync: Just now\n✓ Total Records: 156\n✓ New Records Today: 3\n✓ Sync Status: Active\n\nAll documents are automatically added to your CRM file.');
        }
        
        // Approve document
        function approveDocument(docId) {
            alert('Document Approved!\n\nDocument ID: ' + docId + '\n\nProceeding to create policy with extracted information...');
        }
        
        // Edit extracted data
        function editExtractedData(docId) {
            alert('Opening data editor for: ' + docId + '\n\nYou can correct any OCR extraction errors here.');
        }
        
        // Load documents when section is shown
        const originalShowSection = showSection;
        showSection = function(sectionName) {
            originalShowSection(sectionName);
            if (sectionName === 'documents') {
                refreshDocuments();
            }
        };
    </script>
</body>
</html>
